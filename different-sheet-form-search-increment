// আপনার ডাটা স্টোর স্প্রেডশীট আইডি
const DATA_STORE_ID = "1oMS-QhD4mVQSf6y7WkiF6V_PHSKCh86m5gchReahy38"; 
const OPTICS_MASTER_ID = "1Lg6aU-EDhPNnRWvYNSsWEOyyHMebaHfedHb6kf7Pc8A"; 
const FORM_SHEET_NAME = "Optics Form"; // Optics Form-এর ডেটা এন্ট্রি শীটের নাম (প্রয়োজনে পরিবর্তন করুন)
const TARGET_SHEET_NAME = "Optics Data Store"; // Data Store-এর যে শীটে ডেটা সেভ হবে (প্রয়োজনে পরিবর্তন করুন)

// D6 থেকে D44 পর্যন্ত (মোট 39টি সেল)। 0-ভিত্তিক ইন্ডেক্স ব্যবহার করে প্রয়োজনীয় 31টি সেলের মান নির্বাচন করা হয়েছে।
// এটি আপনার দেওয়া D6=A, D7=B, D9=C...D44=AE ম্যাপিং অনুসরণ করে।
const DATA_INDICES = [
    0, 1, 3, 4, 6, 8, 9, 11, 12, 13, 14, 15, 16, 17, // D6, D7, D9, D10, D12, D14, D15, D17, D18, D19, D20, D21, D22, D23
    19, 20, 21, 22, 23, 24, 25, 26, // D25, D26, D27, D28, D29, D30, D31, D32
    28, 29, 30, 31, 32, 34, 35, 36, 38 // D34, D35, D36, D37, D38, D40, D41, D42, D44
];

/**
 * Optics Form থেকে ডেটা সংগ্রহ করে Data Store-এ একটি নতুন সারি হিসেবে সেভ করে।
 */
function submitData() {
  try {
        // ১. সোর্স স্প্রেডশীট থেকে ডেটা পড়া
        const formSS = SpreadsheetApp.getActiveSpreadsheet();
        const formSheet = formSS.getSheetByName("Optics Form");
        
        // D6 থেকে D44 পর্যন্ত পুরো রেঞ্জটি (39টি সেল) একবারেই পড়ুন
        const dataRange = formSheet.getRange('D6:D44').getValues();
        
        const newRow = [];
        
        // ২. আপনার ম্যাপিং অনুযায়ী ডেটা সাজানো
        // Data Store-এর কলামের ক্রম অনুযায়ী newRow অ্যারে তৈরি করা হচ্ছে।
        for (let i = 0; i < DATA_INDICES.length; i++) {
            const index = DATA_INDICES[i];
            const cellValue = dataRange[index][0]; 
            newRow.push(cellValue);
        }
        
        // ৩. ডেটা স্টোর স্প্রেডশীট ওপেন করা এবং সেভ করা
        const dataStoreSS = SpreadsheetApp.openById(DATA_STORE_ID);
        const targetSheet = dataStoreSS.getSheetByName("Optics Data Store");
        
        // Data Store-এ একটি নতুন সারি যোগ করা
        targetSheet.appendRow(newRow); 
        
        // ৪. ডেটা সেভ হওয়ার পর ফর্ম ক্লিয়ার করা
        var submittedFrameCode = formSheet.getRange("D17").getValue();
        var submittedReadyFrameCode = formSheet.getRange("D25").getValue();
        var submittedGlassCode = formSheet.getRange("D34").getValue();
        clearForm();

        // Sakib Code Starts Here

        const opticsMasterWorkBook = SpreadsheetApp.openById(OPTICS_MASTER_ID);
        const frameSheet = opticsMasterWorkBook.getSheetByName("Sheet1-Frame");
        const readyFrameSheet = opticsMasterWorkBook.getSheetByName("Sheet2-Ready Frame");
        const glassSheet = opticsMasterWorkBook.getSheetByName("Sheet3-Glass");

        // Get all data
        const frameData = frameSheet.getDataRange().getValues();
        const readyFrameData = readyFrameSheet.getDataRange().getValues();
        const glassData = glassSheet.getDataRange().getValues();

        // Identify column positions
        const frameHeader = frameData[0];
        const codeColIndex = frameHeader.indexOf(1);
        const countColIndex = frameHeader.indexOf("Issue or");

        // readyFrame code starts here
        const readyFrameHeader = readyFrameData[0];
        const countColIndexReadyFrame = readyFrameHeader.indexOf("Issue to");
        // readyFrame code ends here

        // glass code starts here
        const glassHeader = glassData[0];
        const countColIndexGlass = glassHeader.indexOf("Issue to");
        // glass code ends here


        if (codeColIndex === -1 || countColIndex === -1) {
          throw new Error("Columns 'Code' or 'Count' not found.");
        }

        // readyFrame code starts here
        if (codeColIndex === -1 || countColIndexReadyFrame === -1) {
          throw new Error("Columns 'Code' or 'Count' not found.");
        }
        // readyFrame code ends here

        // glass code starts here
        if (codeColIndex === -1 || countColIndexGlass === -1) {
          throw new Error("Columns 'Code' or 'Count' not found.");
        }
        // glass code ends here

        // Loop through rows to find the code
        for (let i = 1; i < frameData.length; i++) {
          if (frameData[i][codeColIndex] == submittedFrameCode) {

            let currentValue = frameData[i][countColIndex];

            // If empty or not a number → set 1
            if (!currentValue || isNaN(currentValue)) {
              frameSheet.getRange(i + 1, countColIndex + 1).setValue(1);
            } else {
              // Increment
              frameSheet.getRange(i + 1, countColIndex + 1).setValue(Number(currentValue) + 1);
            }

            break; // Found the code → stop loop
          }
        }

        // readyFrame code starts here
        // Loop through rows to find the code
        for (let i = 1; i < readyFrameData.length; i++) {
          if (readyFrameData[i][codeColIndex] == submittedReadyFrameCode) {

            let currentValue = readyFrameData[i][countColIndexReadyFrame];

            // If empty or not a number → set 1
            if (!currentValue || isNaN(currentValue)) {
              readyFrameSheet.getRange(i + 1, countColIndexReadyFrame + 1).setValue(1);
            } else {
              // Increment
              readyFrameSheet.getRange(i + 1, countColIndexReadyFrame + 1).setValue(Number(currentValue) + 1);
            }

            break; // Found the code → stop loop
          }
        }
        // readyFrame code ends here

        // glass code starts here
        // Loop through rows to find the code
        for (let i = 1; i < glassData.length; i++) {
          if (glassData[i][codeColIndex] == submittedGlassCode) {

            let currentValue = glassData[i][countColIndexGlass];

            // If empty or not a number → set 1
            if (!currentValue || isNaN(currentValue)) {
              glassSheet.getRange(i + 1, countColIndexGlass + 1).setValue(1);
            } else {
              // Increment
              glassSheet.getRange(i + 1, countColIndexGlass + 1).setValue(Number(currentValue) + 1);
            }

            break; // Found the code → stop loop
          }
        }
        // glass code ends here
        // Sakib Code Ends Here
        
        // সফলতার বার্তা
        SpreadsheetApp.getUi().alert("ডেটা সফলভাবে Data Store-এ সেভ হয়েছে!");
        
  } catch (error) {
      // ত্রুটির বার্তা
      SpreadsheetApp.getUi().alert("ডেটা সেভ করার সময় ত্রুটি: " + error.message);
      Logger.log("Error: " + error.toString());
  }
}

/**
 * ফর্মের ডেটা এন্ট্রি সেলগুলি ক্লিয়ার করার ফাংশন।
 */
function clearForm() {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("Optics Form");
    
    // আপনার সমস্ত ইনপুট সেলের রেঞ্জ: D6 থেকে D44
    const clearRange = sheet.getRange('D6:D44');
    clearRange.clearContent();
}

/**
 * স্প্রেডশীটটি খোলার সময় মেনু তৈরি করার ফাংশন।
 */
function onOpen() {
    SpreadsheetApp.getUi()
        .createMenu('✅ ডেটা সেভ')
        .addItem('ডেটা সেভ করুন', 'submitData')
        .addToUi();
}
